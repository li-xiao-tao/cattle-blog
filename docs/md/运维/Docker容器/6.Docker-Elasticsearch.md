---
# 标签
tag:
  - docker
tags:
  - Elasticsearch
# 描述
description: Docker部署Elasticsearch
---
# Docker- Elasticsearch

:::=tabs
::Elasticsearch-v7.14.0

- ik分词器[Release v7.14.0 · medcl/elasticsearch-analysis-ik · GitHub](https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.14.0/elasticsearch-analysis-ik-7.14.0.zip)
- 拼音分词器[Release v7.14.0 · medcl/elasticsearch-analysis-pinyin · GitHub](https://github.com/medcl/elasticsearch-analysis-pinyin/releases/download/v7.14.0/elasticsearch-analysis-pinyin-7.14.0.zip)
- 繁体分词器[elasticsearch-analysis-stconvert](https://github.com/medcl/elasticsearch-analysis-stconvert/releases/download/v7.14.0/elasticsearch-analysis-stconvert-7.14.0.zip)
- 当安装`elasticsearch`、`kibana`、`ik分词器`、`py拼音分词器`时，版本需要全部一致

**elasticsearch 和 kibana要在一个网络下**

## 1.新建 `elasticsearch.yml`

- 给/home/docker/elasticsearch目录权限
  - chmod -R 777 /home/docker/elasticsearch7.14



```sh
vim  /home/docker/elasticsearch7.14/config/elasticsearch.yml
```



```sh
cluster.name: "docker-cluster"
network.host: 0.0.0.0
#开启elasticsearch-head的访问
http.cors.enabled: true
http.cors.allow-origin: "*"
http.cors.allow-headers: Authorization,Content-Type,X-Requested-with,Content-Length
# 此处开启xpack
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
```

## 2.创建容器，挂载配置文件

```sh
docker run -d --name elasticsearch7.14 \
-e "ES_JAVA_OPTS=-Xms1g -Xmx1g" \
-e "discovery.type=single-node" \
-it \
-v /home/docker/elasticsearch7.14/plugins:/usr/share/elasticsearch/plugins \
-v /home/docker/elasticsearch7.14/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \
-v /home/docker/elasticsearch7.14/config/analysis/:/usr/share/elasticsearch/config/analysis \
--net docker_network -p 9200:9200 -p 9300:9300 elasticsearch:7.14.0
```

## 3.进入容器生成密码

```sh
#进入容器
docker exec -it elasticsearch7.14 /bin/bash

#容器内生成 ，按照提示 为每个用户生成密码
./bin/elasticsearch-setup-passwords interactive

Initiating the setup of passwords for reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.
You will be prompted to enter passwords as the process progresses.
Please confirm that you would like to continue [y/N]y


Enter password for [elastic]: 
Reenter password for [elastic]: 
Enter password for [apm_system]: 
Reenter password for [apm_system]: 
Enter password for [kibana_system]: 
Reenter password for [kibana_system]: 
Enter password for [logstash_system]: 
Reenter password for [logstash_system]: 
Enter password for [beats_system]: 
Reenter password for [beats_system]: 
Enter password for [remote_monitoring_user]: 
Reenter password for [remote_monitoring_user]: 
Changed password for user [apm_system]
Changed password for user [kibana_system]
Changed password for user [kibana]
Changed password for user [logstash_system]
Changed password for user [beats_system]
Changed password for user [remote_monitoring_user]
Changed password for user [elastic]

# 重启容器 
docker restart elasticsearch7.14
```

| 用户名 | 描述 |
|--------|------|
| kibana_system | `kibana`在配置`kibana.yml`设置的账号 |
| elastic | 超级管理员 |
| logstash_system | 用户 `Logstash` 在 `Elasticsearch` 中存储监控信息时使用。 |


## 4、安装IK、拼音分词器、繁体stconvert

- 重命名为`ik`、`pinyin`和`stconvert`放置`/home/docker/elasticsearch/plugins`目录

## 5、在kibana控制台查看ik和拼音分词器版本信息

- GET /_cat/plugins?v&s=component&h=name,component,version,description

> d660eb7e4cbe analysis-ik     7.14.0   IK Analyzer for Elasticsearch
>
> d660eb7e4cbe analysis-pinyin 7.14.0   Pinyin Analysis for Elasticsearch
>
> 39a30abb1d8b analysis-stconvert 7.14.0  STConvert is a analysis plugin that convert Chinese characters between traditional and simplified.

::Elasticsearch-v8.6.0

- ik分词器[Release v8.6.0 · medcl/elasticsearch-analysis-ik · GitHub](https://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v8.6.0)
- 拼音分词器[Release v8.6.0 · medcl/elasticsearch-analysis-pinyin · GitHub](https://github.com/medcl/elasticsearch-analysis-pinyin/releases/tag/v8.6.0)
- 繁体分词器[elasticsearch-analysis-stconvert](https://github.com/medcl/elasticsearch-analysis-stconvert/releases/download/v8.6.0/elasticsearch-analysis-stconvert-8.6.0.zip)
- 当安装`elasticsearch`、`kibana`、`ik分词器`、`py拼音分词器`时，版本需要全部一致

**elasticsearch 和 kibana要在一个网络下**

## 1.创建容器并拷贝容器内`elasticsearch.yml`

```sh
docker run -d --name elasticsearch8.6 \
-e ES_JAVA_OPTS="-Xms1g -Xmx1g" \
-e "discovery.type=single-node" \
-it \
-v /home/docker/elasticsearch8.6/data:/usr/share/elasticsearch/data \
-v /home/docker/elasticsearch8.6/plugins:/usr/share/elasticsearch/plugins \
--net docker_network -p 9201:9200 -p 9301:9300 elasticsearch:8.6.0
```

- docker cp elasticsearch:/usr/share/elasticsearch/config/elasticsearch.yml /home/docker/elasticsearch8.6/config/elasticsearch.yml

## 2.在`elasticsearch.yml`添加

- 给/home/docker/elasticsearch8.6目录权限
  - chmod -R 777 /home/docker/elasticsearch8.6


```sh
#此处开启xpack
xpack.security.enabled: true
#开启密码
xpack.security.audit.enabled: true
```

## 3.删除旧容器，生成新容器，挂载配置文件

```sh
docker run -d --name elasticsearch8.6 \
-e "ES_JAVA_OPTS=-Xms1g -Xmx1g" \
-e "discovery.type=single-node" \
-it \
-v /home/docker/elasticsearch8.6/plugins:/usr/share/elasticsearch/plugins \
-v /home/docker/elasticsearch8.6/logs:/usr/share/elasticsearch/logs \
-v /home/docker/elasticsearch8.6/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \
--net docker_network -p 9201:9200 -p 9301:9300 elasticsearch:8.6.0
```

## 4.进入容器生成`ca`、`cert`

- `ca: elastic-stack-ca.p12`、`cert: elastic-certificates.p12`

```sh
#进入容器
docker exec -it elasticsearch8.6 /bin/bash
#容器内生成 一路回车就行
./bin/elasticsearch-certutil ca
# 容器内生成
./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12
# 生成后需要移到config下面
mv elastic-certificates.p12 ./config
```

## 5.进入容器生成密码，并保存到本地

```sh
#容器内生成 ，按提示输入 y
./bin/elasticsearch-setup-passwords auto

# 复制保存密码
Changed password for user apm_system
PASSWORD apm_system = OULwLkj4YAnDmVb2Memx

Changed password for user kibana_system
PASSWORD kibana_system = 2PC7jbRhlTC8cTQTPW8m

Changed password for user kibana
PASSWORD kibana = 2PC7jbRhlTC8cTQTPW8m

Changed password for user logstash_system
PASSWORD logstash_system = uKd1hQ9GhXgpnKIINg4Z

Changed password for user beats_system
PASSWORD beats_system = 8FXf6EBVoKlNdumu5rBO

Changed password for user remote_monitoring_user
PASSWORD remote_monitoring_user = HFQqFCVt9iUVTti44roG

Changed password for user elastic
PASSWORD elastic = i36yydhKDZo8XFUUT57i
```

## 6、再次修改配置,并重启

- vi /home/docker/elasticsearch8.6/config/elasticsearch.yml

```
# 启用 Elasticsearch 安全功能
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.keystore.type: PKCS12
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: elastic-certificates.p12
xpack.security.transport.ssl.truststore.type: PKCS12
# 开启密码
xpack.security.audit.enabled: true
```

- 重启容器 docker restart elasticsearch8.6

## 7、  修改密码【上一步密码生成并重启才能修改】

- 更改密码

  - kibana_system       kibana在配置kibana.yml设置的账号
  - elastic                       超级管理员
  - logstash_system    用户 Logstash 在 Elasticsearch 中存储监控信息时使用。

- ```sh
  #进入容器
  docker exec -it elasticsearch /bin/bash
  
  #进入es bin目录
  cd bin/
  
  # 修改密码
  ./elasticsearch-reset-password --username kibana -i
  执行命令之后，输入y 在输入两次密码即可 【密码长度要6位】
  ```


## 8、安装IK、拼音分词器、繁体stconvert

- 重命名为`ik`、`pinyin`和`stconvert`放置`/home/docker/elasticsearch/plugins`目录


## 9、拼音分词器版本信息

- GET /_cat/plugins?v&s=component&h=name,component,version,description

> d660eb7e4cbe analysis-ik     8.6.0   IK Analyzer for Elasticsearch
>
> d660eb7e4cbe analysis-pinyin 8.6.0   Pinyin Analysis for Elasticsearch
>
> 39a30abb1d8b analysis-stconvert 8.6.0  STConvert is a analysis plugin that convert Chinese characters between traditional and simplified.

:::
